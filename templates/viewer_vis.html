{% extends "layout.html" %}

{% block extra_head %}
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #f8f9fa;
        }
        #network {
            width: 100vw;
            height: 100vh;
            border: 1px solid #ddd;
            background: white;
        }
        #statement-popup::-webkit-scrollbar {
            width: 6px;
        }
        #statement-popup::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 3px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">VIS Graph â€“ Rule: <code>{{ rule_name }}</code></h4>
        <button id="show-statement" class="btn btn-outline-info btn-sm">View Rule Statement</button>
    </div>
    <div id="graph-container">
        <div id="network"></div>
    </div>

    <!-- Floating Rule Statement Box -->
    <div id="statement-popup" class="card shadow-lg" style="display:none; position:fixed; top:80px; left:80px; z-index:9999; max-width: 600px; max-height: 400px; overflow: auto; cursor: move;">
        <div class="card-header bg-dark text-white p-2">
            Rule Statement
        </div>
        <div class="card-body p-2 bg-light">
            <pre style="white-space: pre-wrap;">{{ rule_statement | tojson(indent=2) }}</pre>
        </div>
    </div>
</div>



<script type="text/javascript">
    const nodes = new vis.DataSet({{ nodes | tojson }});
    const edges = new vis.DataSet({{ edges | tojson }});

    const container = document.getElementById("network");
    const data = { nodes: nodes, edges: edges };
    const options = {
        layout: {
            improvedLayout: true,
            hierarchical: { enabled: false }
        },
        physics: {
            enabled: true,
            solver: "forceAtlas2Based",
            stabilization: { iterations: 150 }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200,
            navigationButtons: true,
            keyboard: true
        },
        edges: {
            arrows: { to: { enabled: true, scaleFactor: 0.7 } },
            font: { align: "middle" },
            smooth: { type: "dynamic" }
        },
        nodes: {
            shape: "box",
            color: { background: "#e3f2fd", border: "#2196f3" },
            font: { color: "#0d47a1", face: "monospace" },
            margin: 10
        }
    };

    const network = new vis.Network(container, data, options);
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Zoom & pan for mermaid
        const interval = setInterval(() => {
            const svg = document.querySelector("svg");
            if (svg) {
                svgPanZoom(svg, {
                    zoomEnabled: true,
                    controlIconsEnabled: true,
                    fit: true,
                    center: true,
                    minZoom: 0.2,
                    maxZoom: 10
                });
                clearInterval(interval);
            }
        }, 200);
    
        // Toggle popup
        const popup = document.getElementById("statement-popup");
        const trigger = document.getElementById("show-statement");
    
        trigger.addEventListener("click", function (e) {
            popup.style.display = "block";
            e.stopPropagation();  // Prevent immediate close
        });
    
        // Close popup on outside click
        document.addEventListener("click", function () {
            popup.style.display = "none";
        });
    
        popup.addEventListener("click", function (e) {
            e.stopPropagation();  // Clicking inside shouldn't close it
        });
    
        // Make popup draggable
        let isDragging = false, offsetX = 0, offsetY = 0;
    
        const header = popup.querySelector(".card-header");
        header.addEventListener("mousedown", function (e) {
            isDragging = true;
            offsetX = e.clientX - popup.offsetLeft;
            offsetY = e.clientY - popup.offsetTop;
            popup.style.cursor = "grabbing";
        });
    
        document.addEventListener("mousemove", function (e) {
            if (isDragging) {
                popup.style.left = `${e.clientX - offsetX}px`;
                popup.style.top = `${e.clientY - offsetY}px`;
            }
        });
    
        document.addEventListener("mouseup", function () {
            isDragging = false;
            popup.style.cursor = "move";
        });
    });
    </script>
{% endblock %}
