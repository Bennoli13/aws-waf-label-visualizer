{% extends "layout.html" %}
{% block extra_head %}
    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SVG Pan Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <style>
        .mermaid {
            width: 100%;
            height: 100%;
        }
        svg[id^="mermaid-"] {
            height: 600px !important;
            max-height: 1000px;
        }
        #statement-popup::-webkit-scrollbar {
            width: 6px;
        }
        #statement-popup::-webkit-scrollbar-thumb {
            background-color: #aaa;
            border-radius: 3px;
        }
    </style>
    

{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">Mermaid Graph â€“ Rule: <code>{{ rule_name }}</code></h4>
            <button id="show-statement" class="btn btn-outline-info btn-sm">View Rule Statement</button>
        </div>
        <div id="graph-container">
            <div class="mermaid">
    {{ graph }}
            </div>
        </div>

        <!-- Floating Rule Statement Box -->
        <div id="statement-popup" class="card shadow-lg" style="display:none; position:fixed; top:80px; left:80px; z-index:9999; max-width: 600px; max-height: 400px; overflow: auto; cursor: move;">
            <div class="card-header bg-dark text-white p-2">
                Rule Statement
            </div>
            <div class="card-body p-2 bg-light">
                <pre style="white-space: pre-wrap;">{{ rule_statement | tojson(indent=2) }}</pre>
            </div>
        </div>
    </div>


    <script>
        // Wait until SVG is rendered
        document.addEventListener("DOMContentLoaded", function () {
            const interval = setInterval(() => {
                const svg = document.querySelector("svg");
                if (svg) {
                    svgPanZoom(svg, {
                        zoomEnabled: true,
                        controlIconsEnabled: true,
                        fit: true,
                        center: true,
                        minZoom: 0.2,
                        maxZoom: 10
                    });
                    clearInterval(interval);
                }
            }, 200); // Retry every 200ms until Mermaid finishes rendering
        });
    </script>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Zoom & pan for mermaid
            const interval = setInterval(() => {
                const svg = document.querySelector("svg");
                if (svg) {
                    svgPanZoom(svg, {
                        zoomEnabled: true,
                        controlIconsEnabled: true,
                        fit: true,
                        center: true,
                        minZoom: 0.2,
                        maxZoom: 10
                    });
                    clearInterval(interval);
                }
            }, 200);
        
            // Toggle popup
            const popup = document.getElementById("statement-popup");
            const trigger = document.getElementById("show-statement");
        
            trigger.addEventListener("click", function (e) {
                popup.style.display = "block";
                e.stopPropagation();  // Prevent immediate close
            });
        
            // Close popup on outside click
            document.addEventListener("click", function () {
                popup.style.display = "none";
            });
        
            popup.addEventListener("click", function (e) {
                e.stopPropagation();  // Clicking inside shouldn't close it
            });
        
            // Make popup draggable
            let isDragging = false, offsetX = 0, offsetY = 0;
        
            const header = popup.querySelector(".card-header");
            header.addEventListener("mousedown", function (e) {
                isDragging = true;
                offsetX = e.clientX - popup.offsetLeft;
                offsetY = e.clientY - popup.offsetTop;
                popup.style.cursor = "grabbing";
            });
        
            document.addEventListener("mousemove", function (e) {
                if (isDragging) {
                    popup.style.left = `${e.clientX - offsetX}px`;
                    popup.style.top = `${e.clientY - offsetY}px`;
                }
            });
        
            document.addEventListener("mouseup", function () {
                isDragging = false;
                popup.style.cursor = "move";
            });
        });
        </script>
        
{% endblock %}
